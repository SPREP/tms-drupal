<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Home</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <style>
    .chatbox {
      outline: 1px solid silver;
      min-height: 160px;
      padding: 0.5em;
    }
  </style>

</head>
<body>
<div class="container mt-3">

  <div class="row">
    <div class="col">
      <div class="row">
        <div class="col-md-2">
          <img class="brand-logo" src="tms-logo.png" alt="logo" aria-hidden="true" style="width: 90%; height: auto;"></div>
        <div class="col-md-10 my-auto"><h1>Earthquake Report Monitoring</h1></div>
      </div>
      <hr>
    </div>
  </div>

  <div class="row">
    <div class="col-md-5">
      <h3>Report Status</h3>

      <table class="table table-striped" id="status-table">
        <thead>
        <tr>
          <th scope="col">#</th>
          <th scope="col">Location</th>
          <th scope="col">Lat</th>
          <th scope="col">Lon</th>
          <th scope="col">Rating</th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>

    </div>


    <div class="col-md-7">
      <canvas id="charts"></canvas>
    </div>
  </div>
</div>
<audio id="payloadAlert" muted>
  <source
    src="mixkit-signal-alert-771.wav"
  />
</audio>

</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let socket = null;

  window.onbeforeunload = function() {
    console.log("Leaving");
    let jsonData = {};
    jsonData["action"] = "left";
    socket.send(JSON.stringify(jsonData));
  }




  document.addEventListener("DOMContentLoaded", function(){
    // socket = new WebSocket("ws://app.met.gov.to:5123");

    socket = new WebSocket("ws://127.0.0.1:8080");
    let isChart = null;
    $("body").trigger("click"); //<-- just to allow browser to play sound


    socket.onopen = () => {
      console.log("Successfully connected");
    }

    socket.onclose = () => {
      console.log("connection closed");
    }

    socket.onerror = error => {
      console.log("there was an error");
    }

    socket.onmessage = msg => {
      let data = JSON.parse(msg.data);
      let alert = document.getElementById('payloadAlert');

      const clickSound = new Audio('mixkit-signal-alert-771.wav');


      switch (data.action) {
        case "message":

          $("#status-table > tbody").prepend("<tr><th scope='row'>#</th><td>" + data.Payload.Location + "</td><td>" + data.Payload.Lat + "</td><td>" + data.Payload.Lng + "</td><td>" + data.Payload.Rate + "</td></tr>");
          clickSound.play().catch(function (error) {
            console.log("Chrome cannot play sound without user interaction first");
          });

          //show chart
          const ctx = document.getElementById('charts');

          if (isChart != null) isChart.destroy();

          isChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: ['Tongatapu', 'Vavau', 'Haapai', 'Eua', 'Niuafoou', 'Niuatoputapu'],
              datasets: [
                {
                label: '# of Weak',
                data: [12, 19, 3, 5, 2, 3],
                borderWidth: 1,
                //backgroundColor: Utils.CHART_COLORS.red,
              },
                {
                  label: '# of Light',
                  data: [6, 12, 10, 2, 0, 6],
                  borderWidth: 1,
                  //backgroundColor: Utils.CHART_COLORS.blue,
                },
                {
                  label: '# of Moderate',
                  data: [2, 9, 13, 8, 12, 9],
                  borderWidth: 1,
                 // backgroundColor: Utils.CHART_COLORS.green,
                },
                {
                  label: '# of Strong',
                  data: [6, 19, 3, 5, 2, 13],
                  borderWidth: 1,
                 // backgroundColor: Utils.CHART_COLORS.yellow,
                },
                {
                  label: '# of Major',
                  data: [15, 3, 3, 15, 2, 3],
                  borderWidth: 1,
                 // backgroundColor: Utils.CHART_COLORS.green,
                },

                {
                  label: '# of Severe',
                  data: [15, 3, 3, 15, 2, 3],
                  borderWidth: 1,
                 // backgroundColor: Utils.CHART_COLORS.red,
                },

              ]
            },
            options: {
              responsive: true,
              scales: {
                x: {
                  stacked: true,
                },
                y: {
                  stacked: true
                }
              }
            }
          });

          break;
      }

      //console.log(j);
    }

  })
</script>
</html>
